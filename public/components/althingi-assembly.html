<!--
    ALTHINGI-ASSEMBLY-LIST

    List of ALTHINGI-ASSEMBLY-BADGEes. Batches
    are loaded in via XHR calls
-->
<dom-module id="althingi-assembly-list">
    <template>
        <althingi-pagination
                href="/api/loggjafarthing"
                on-response="handleResponse"
                on-request="handleRequest"
                on-done="handleDone">
        </althingi-pagination>
        <althingi-preloader on-request-next="handleMore">
            <template is="dom-repeat" items="{{assemblies}}">
                <althingi-assembly-badge
                        from="{{item.from}}"
                        to="{{item.to}}"
                        assembly="{{item.assembly_id}}">
                </althingi-assembly-badge>
            </template>
        </althingi-preloader>
    </template>
    <script>
        Polymer({
            is: "althingi-assembly-list",

            /**
             * This object's properties.
             *
             * @var Object
             */
            properties: {
                assemblies: {
                    type: Array,
                    value: []
                }
            },

            /**
             * Handles when PAGINATOR starts to fetch data.
             *
             * @param event CustomEvent
             */
            handleRequest: function (event) {
                this.querySelector('althingi-preloader').setAttribute('state', 'load');
            },

            /**
             * Handles when PAGINATOR has some data for us.
             *
             * @param event CustomEvent
             */
            handleResponse: function (event) {
                this.querySelector('althingi-preloader').setAttribute('state', 'halt');
                this.assemblies = this.assemblies.concat(event.detail);
            },

            /**
             * Handles when PAGINATOR is done getting all data.
             *
             * @param event CustomEvent
             */
            handleDone: function (event) {
                this.querySelector('althingi-preloader').setAttribute('state', 'done');
            },

            /**
             * Handles when user click on a button to get
             * more data from PAGINATOR.
             *
             * @param event MouseEvent
             */
            handleMore: function (event) {
                this.querySelector('althingi-pagination').load();
            }
        });
    </script>
</dom-module>

<!--

    ALTHINGI-ASSEMBLY-BADGE

    Item in a list of assemblies.
    This includes the number of assembly,
    the begin and end date.
-->
<dom-module id="althingi-assembly-badge">
    <style>
        :host {
            margin: 30px 0;
        }
    </style>
    <template>
        <paper-item>
            <paper-item-body>
                <div>{{assembly}}</div>
                <div secondary>
                    <time>{{from}}</time> -
                    <time>{{to}}</time>
                </div>
            </paper-item-body>
            <paper-icon-button
                    icon="arrow-forward"
                    on-click="clickIssuesGet">
            </paper-icon-button>
            <!--paper-button on-click="clickPlenariesGet" raised>Ãžingfundir</paper-button-->
        </paper-item>
    </template>

    <script>
        Polymer({
            is: "althingi-assembly-badge",

            /**
             * When user wants plenaries from a given
             * assembly in the list.
             *
             * @event plenaries-get
             * @param String URL
             */

            /**
             * When user wants issues from a give
             * assembly in the list.
             *
             * @event issues-get
             * @param String URL
             */

            /**
             * Properties for this object
             * @var Object
             */
            properties: {
                assembly: {
                    type: String,
                    reflectToAttribute: true
                },
                from: {
                    type: String,
                    reflectToAttribute: true
                },
                to: {
                    type: String,
                    reflectToAttribute: true
                }
            },

            /**
             * Handle click event for 'get plenaries' button.
             * Will file 'plenaries-get' event
             * @param MouseEvent event
             * @var Function
             */
            clickPlenariesGet: function (event) {
                this.fire('plenaries-get', {assembly: this.assembly});
            },

            /**
             * Handle click event for 'get issues' button
             * Will fire 'issues-get' event
             * @param MouseEvent event
             * @var Function
             */
            clickIssuesGet: function (event) {
                this.fire('issues-get', {assembly: this.assembly});
                //this.fire('issues-get', '/api/loggjafarthing/' + this.assembly + '/thingmal');
            }
        });
    </script>
</dom-module>

<dom-module id="althingi-assembly-profile">
    <template>
        <iron-ajax
                auto
                on-response="handleResponse"
                handle-as="json"
                url="{{url}}">
        </iron-ajax>
        <h1>{{data.assembly_id}}</h1>
        <svg-piechart size="250" data="{{issues}}"></svg-piechart>
        <template is="dom-repeat" items="{{data.congressmen}}">
            <althingi-congressman-badge
                    congressman="{{item.congressman_id}}"
                    name="{{item.name}}">
            </althingi-congressman-badge>
        </template>
    </template>
    <script>
        Polymer({

            is: 'althingi-assembly-profile',

            properties: {
                assembly: {
                    type: Number,
                    observer: 'changeAssembly'
                },

                url: {
                    type: String
                },

                data: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },

                issues: {
                    type: Array,
                    value: []
                }
            },

            observers: [
                'updateChart(data.issues)'
            ],

            changeAssembly: function (newValue, oldValue) {
                this.data = {};
                this.url = '/api/loggjafarthing/' + newValue;
            },

            handleResponse: function (event) {
                this.data = event.detail.response;
            },

            updateChart: function (issues) {
                if (issues !== undefined) {
                    this.issues = issues.map(function (item) {
                        return parseInt(item.total)
                    });
                }

            }
        })
    </script>
</dom-module>
